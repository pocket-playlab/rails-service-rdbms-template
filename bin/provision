#!/bin/bash --login
# Sets up a development environment inside a vagrant vm

set -e

# cd straight to /vagrant on login
if ! grep -q 'cd \/vagrant' ~/.bashrc; then
  echo 'cd /vagrant' >> ~/.bashrc
fi
cd /vagrant

# Install packages
sudo apt-get update --quiet
sudo -E apt-get install --quiet --assume-yes \
  git postgresql libpq-dev redis-server

# Install rvm and ruby
pattern="^ruby '([0-9\.]+)'$"
version=$(grep -E "$pattern" Gemfile | sed -E "s/$pattern/\1/g")
if [[ ! $version ]]; then
  echo "Can't find ruby version in Gemfile"
  exit 1
fi
if ! rvm use ruby-$version; then
  gpg --keyserver hkp://keys.gnupg.net --recv-keys D39DC0E3
  curl -sSL https://get.rvm.io | bash -s stable
  source ~/.rvm/scripts/rvm
  rvm install --quiet-curl ruby-$version
  rvm use ruby-$version
fi

# Install ruby dependencies
bundle install

# Create database
echo "CREATE DATABASE development WITH ENCODING 'utf-8' TEMPLATE template0;" |
  sudo -u postgres psql || echo 'development database already created'

# Create database user
echo "CREATE USER playlab WITH PASSWORD 'PocketPlay';" |
  sudo -u postgres psql || echo 'database user already created'

# Allow postgres login with password
sudo tee /etc/postgresql/9.3/main/pg_hba.conf << 'EOF'
local   all             all                                     md5
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5
EOF
sudo service postgresql restart

# Load schema
rake db:schema:load

# Run the tests
rspec --format documentation
