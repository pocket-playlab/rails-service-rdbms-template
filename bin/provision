#!/bin/bash --login
# Sets up a development environment inside a vagrant vm

set -e

# cd straight to /vagrant on login
if ! grep -q 'cd \/vagrant' ~/.bashrc; then
  echo 'cd /vagrant' >> ~/.bashrc
fi
cd /vagrant

# Install packages
echo 'deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main' |
  sudo tee /etc/apt/sources.list.d/postgresql.list
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc |
  sudo apt-key add -
sudo apt-add-repository --yes ppa:brightbox/ruby-ng
sudo apt-get update --quiet
sudo apt-get install --quiet --assume-yes \
  git postgresql-9.4 libpq-dev libsqlite3-dev redis-server ruby2.2 ruby2.2-dev

# Install ruby dependencies
sudo gem install bundler
bundle install

# Allow postgres login from localhost without password
sudo tee /etc/postgresql/9.4/main/pg_hba.conf << 'EOF'
local   all             all                                     trust
host    all             all             127.0.0.1/32            trust
host    all             all             ::1/128                 trust
EOF
sudo service postgresql restart

# Create database user
sudo -u postgres createuser --createdb vagrant ||
  echo 'database user already created'

# Load schema
rake db:setup

# Run the tests
rspec --format documentation
